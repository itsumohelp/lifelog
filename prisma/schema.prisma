// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model TeslaAccount {
  id            String   @id @default(cuid())
  teslaSub      String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  vehicles      TeslaVehicle[]
  dailySnapshot TeslaVehicleDailySnapshot[]
  settings  TeslaSettings?
  authToken TeslaAuthToken?
  syncJob SyncJob[]
}

model TeslaVehicle {
  id                 String   @id @default(cuid())
  teslaAccountId  String
  teslaAccount    TeslaAccount  @relation(fields: [teslaAccountId], references: [id], onDelete: Cascade)
  teslaVehicleId     BigInt   @unique
  displayName        String?
  state              String?
  accessType         String?
  teslaVehicleIdS    String?  @unique
  rawJson            Json?
  vehicleGrade       String?
  capacityKwh        Float?
  firstSeenAt        DateTime @default(now())
  lastSeenAt         DateTime @updatedAt
  vehicleOptions VehicleOptions[]
  override       TeslaVehicleOverride?
  @@unique([teslaAccountId, teslaVehicleId])
  @@unique([teslaAccountId, teslaVehicleIdS])
}

model TeslaVehicleOverride {
  id              String       @id @default(cuid())
  vehicleId       String       @unique
  teslaVehicle    TeslaVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  displayName     String?
  vehicleGrade    String?
  capacityKwh     Float?
  confirmedAt     DateTime?
  isPublic        Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model VehicleOptions {
  id                 String   @id @default(cuid())
  vehicleId          String
  teslaVehicle       TeslaVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  code               String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  @@unique([vehicleId, code])
}

model TeslaVehicleDailySnapshot {
  id             String       @id @default(cuid())
  teslaAccountId String
  teslaAccount   TeslaAccount @relation(fields: [teslaAccountId], references: [id], onDelete: Cascade)
  teslaVehicleId BigInt
  snapshotDate   DateTime
  batteryLevel   Int?     // %
  chargeLimitSoc Int?     // %
  odometerKm     Float?   // km（取れたら）
　fetchedAt      DateTime @default(now())
  batteryRangeKm    Float?
  estBatteryRangeKm Float?
  outsideTemp Float?
  insideTemp  Float?
  chargeEnergyAdded Float?
  status Boolean    @default(false)
  prevSnapshotDate　DateTime?
  odometerDeltaKm Float?
  batteryDeltaPct Int?
  energyUsedKwh Float?
  efficiencyKmPerKwh Float?
  efficiencyType String?
  // 充電履歴から取得した充電量（kWh）
  chargedKwhFromHistory Float?
  // 充電履歴取得済みフラグ
  chargingHistoryFetched Boolean @default(false)
  @@unique([teslaAccountId, teslaVehicleId, snapshotDate], name: "uniq_daily_snapshot")
  @@index([teslaAccountId, snapshotDate])
}

model TeslaSettings {
  id            String @id @default(cuid())
  teslaAccountId String @unique
  teslaAccount   TeslaAccount @relation(fields: [teslaAccountId], references: [id], onDelete: Cascade)

  mode          TeslaMode @default(MANUAL)
  consentGivenAt DateTime?
  consentVersion String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TeslaMode {
  MANUAL
  AUTO
}

model TeslaAuthToken {
  id            String @id @default(cuid())
  teslaAccountId String @unique
  teslaAccount   TeslaAccount @relation(fields: [teslaAccountId], references: [id], onDelete: Cascade)

  accessTokenEnc  String?
  refreshTokenEnc String
  expiresAt       DateTime

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}


model TeslaFleetApiCallLog {
  id             String       @id @default(cuid())
  teslaAccountId String
  method       String
  path         String
  query        Json?
  requestBody  Json?
  purpose      String?   // "DAILY_SNAPSHOT" / "USER_ACTION" etc
  jobRunId     String?   // cron実行IDなど
  teslaVehicleId BigInt? // 対象車両が特定できるなら入れる
  statusCode   Int?
  durationMs   Int?
  isSuccess    Boolean    @default(false)
  errorType    String?    // "HTTP" | "TIMEOUT" | "NETWORK" | "PARSING"
  errorMessage String?    // truncate推奨
  userAgent    String?
  ipHash       String?
  createdAt    DateTime   @default(now())
  @@index([teslaAccountId, createdAt])
  @@index([path, createdAt])
  @@index([purpose, createdAt])
  @@index([teslaVehicleId, createdAt])
}

model SyncJob {
  id            String   @id @default(cuid())
  teslaAccountId String
  teslaAccount   TeslaAccount @relation(fields: [teslaAccountId], references: [id], onDelete: Cascade)
  jobType       SyncJobType
  status        SyncJobStatus
  scheduledAt   DateTime
  startedAt     DateTime?
  finishedAt    DateTime?

  attempt       Int      @default(0)
  lastError     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status, scheduledAt])
  @@index([teslaAccountId, jobType])
}

enum SyncJobType {
  SYNC_VEHICLES
}

enum SyncJobStatus {
  WAITING   // 実行待ち
  RUNNING   // 実行中
  SUCCESS   // 成功
  FAILED    // 失敗
}
